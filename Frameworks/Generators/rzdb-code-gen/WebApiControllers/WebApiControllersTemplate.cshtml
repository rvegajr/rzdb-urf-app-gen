@using System.Collections.Generic
@using System.Linq
@using RzDb.CodeGen
@{ SchemaData _Model = (SchemaData)Model; }

@foreach (string key in _Model.Keys){<t>##FILE=$OUTPUT_PATH$@key<t/>Controller.cs
@if (key.StartsWith("VwCustomer"))
{
    var keys = key.ToLower();
}

//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated from a template.
//
//     Manual changes to this file may cause unexpected behavior in your application.
//     Manual changes to this file will be overwritten if the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------
using System.Linq;
using System.Web.OData;
using System.Web.OData.Query;
using System.Web.OData.Routing;
using Repository.Pattern.UnitOfWork;
using System.Web.Http;
using System.Threading.Tasks;
using System.Net;
using Repository.Pattern.Infrastructure;
using System.Data.Entity.Infrastructure;
using DataAccess.Models;
using Service;
using System;

namespace WebApi.Controllers
{
        /// <summary></summary>
        [ODataRoutePrefix("@key<t/>")]
        public partial class @key<t/>Controller : ODataController
        {
            private readonly I<t/>@key.ToSingular()Service _service;
            private readonly IUnitOfWorkAsync _unitOfWorkAsync;
    
            /// <summary></summary>
            public @key<t/>Controller( 
                IUnitOfWorkAsync unitOfWorkAsync,
                I<t/>@key.ToSingular()Service service)
            {
                _unitOfWorkAsync = unitOfWorkAsync;
                _service = service;
            }
    
            /// <summary></summary>
            [HttpGet]
            [ODataRoute]
            [EnableQuery]
            public IQueryable<@key.ToSingular()> Get<t/>@key<t/>()
            {
                return _service.Queryable();
            }
    
            /// <summary></summary>
            [HttpGet]
            [ODataRoute]
            [EnableQuery]
            public SingleResult<@key.ToSingular()> Get<t/>@key.ToSingular()FromId(@_Model[key].PrimaryKeys.AsParmString())
            {
                return SingleResult.Create(_service.Queryable().Where(t => @_Model[key].PrimaryKeys.AsLinqEquationString() ));
            }
    
            /// <summary></summary>
            [HttpGet]
            [ODataRoute("@_Model[key].PrimaryKeys.AsODataRouteString()")]
            [EnableQuery]
            public SingleResult<@key.ToSingular()> Get<t>@key.ToSingular()</t>(@_Model[key].PrimaryKeys.AsParmString())
            {
                return SingleResult.Create(_service.Queryable().Where(t => @_Model[key].PrimaryKeys.AsLinqEquationString() ));
            }

@if (@_Model[key].Type.Equals("Table")) {<t>

            /// <summary></summary>
            [HttpPut]
            [ODataRoute("@_Model[key].PrimaryKeys.AsODataRouteString()")]
            public async Task<IHttpActionResult> Put(@_Model[key].PrimaryKeys.AsParmString(), @key.ToSingular() item)
            {
                if (!ModelState.IsValid)
                {
                    return BadRequest(ModelState);
                }
                if (@_Model[key].PrimaryKeys.AsParmBooleanCheck("item"))
                {
                    return BadRequest();
                }
    
                item.ObjectState = ObjectState.Modified;
                _service.Update(item);
    
                try
                {
                    await _unitOfWorkAsync.SaveChangesAsync();
                }
                catch (DbUpdateConcurrencyException)
                {
                    if (!ItemExists(@_Model[key].PrimaryKeys.AsCsvString()))
                    {
                        return NotFound();
                    }
                    throw;
                }
    
                return Updated(item);
            }
    
            /// <summary></summary>
            [HttpPost]
            [ODataRoute]
            public async Task<IHttpActionResult> Post(@key.ToSingular() item)
            {
                if (!ModelState.IsValid)
                {
                    return BadRequest(ModelState);
                }
    
                item.ObjectState = ObjectState.Added;
                _service.Insert(item);
    
                try
                {
                    await _unitOfWorkAsync.SaveChangesAsync();
                }
                catch (DbUpdateException)
                {
                    if (ItemExists(@_Model[key].PrimaryKeys.AsCsvString("item")))
                    {
                        return Conflict();
                    }
                    throw;
                }
    
                return Created(item);
            }
    
            /// <summary></summary>
            [HttpPatch]
            [AcceptVerbs("PATCH", "MERGE")]
            [ODataRoute("@_Model[key].PrimaryKeys.AsODataRouteString()")]
            public async Task<IHttpActionResult> Patch(@_Model[key].PrimaryKeys.AsParmString(), Delta<@key.ToSingular()> patch)
            {
                if (!ModelState.IsValid)
                {
                    return BadRequest(ModelState);
                }
    
                var item = await _service.FindAsync( @_Model[key].PrimaryKeys.AsCsvString() );
    
                if (item == null)
                {
                    return NotFound();
                }
    
                patch.Patch(item);
                item.ObjectState = ObjectState.Modified;
    
                try
                {
                    await _unitOfWorkAsync.SaveChangesAsync();
                }
                catch (DbUpdateConcurrencyException)
                {
                    if (!ItemExists( @_Model[key].PrimaryKeys.AsCsvString() ))
                    {
                        return NotFound();
                    }
                    throw;
                }
    
                return Updated(item);
            }
    
            /// <summary></summary>
            [HttpDelete]
            [ODataRoute]
            public async Task<IHttpActionResult> Delete(@_Model[key].PrimaryKeys.AsParmString())
            {
                var item = await _service.FindAsync(@_Model[key].PrimaryKeys.AsCsvString());
    
                if (item == null)
                {
                    return NotFound();
                }
    
                item.ObjectState = ObjectState.Deleted;
    
                _service.Delete(item);
                await _unitOfWorkAsync.SaveChangesAsync();
    
                return StatusCode(HttpStatusCode.NoContent);
            }

            /// <summary></summary>
            private bool ItemExists(@_Model[key].PrimaryKeys.AsParmString())
            {
                return _service.Query(t => @_Model[key].PrimaryKeys.AsLinqEquationString()).Select().Any();
            }
    
            /// <summary></summary>
            protected override void Dispose(bool disposing)
            {
                if (disposing)
                {
                    _unitOfWorkAsync.Dispose();
                }
                base.Dispose(disposing);
            }
</t>}    
        }
}
</t>}